name: deploy-infra-and-apis
on:
  push:
    paths:
      - "api/**"
  workflow_dispatch:

env:
  LOCATION: uksouth
  RG_NAME: photo-app-uksouth-rg
  PHOTO_API_NAME: photo-api
  PHOTO_API_PORT: 8080
  RESIZE_API_NAME: resize-api
  RESIZE_API_PORT: 8080
  VERSION: 1.0.0

jobs:
  deploy-acr-job:
    runs-on: ubuntu-latest
    outputs:
      acrName: ${{ steps.deploy-acr-outputs.outputs.acrName }}
    steps:
      - name: checkout-code
        uses: actions/checkout@main

      - name: log-into-azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: create-resource-group
        uses: azure/CLI@v1
        with:
          azcliversion: 2.67.0
          inlineScript: |
            az group create --name ${{ env.RG_NAME }} --location ${{ env.LOCATION }}

      - name: deploy-acr
        id: deploy-acr
        uses:  azure/arm-deploy@v2
        with:
          deploymentName: deploy-acr
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ env.RG_NAME }}
          template: ./infra/modules/acr.bicep


      - name: deploy-acr-outputs
        run: |
          echo "ACR_NAME: ${{ steps.deploy-acr.outputs.acrName }}"
          echo "ACR_NAME=${{ steps.deploy-acr.outputs.acrName }}" >> "$GITHUB_OUTPUT"
  
  build-photo-api-job:
    runs-on: ubuntu-latest
    needs: [deploy-acr-job]
    env:
      PHOTO_API_IMAGE: "${{ needs.deploy-acr-job.outputs.acrName }}.azurecr.io/${{ vars.PHOTO_API_NAME }}:${{ vars.VERSION }}"
      ACR_NAME: ${{ needs.deploy-acr-job.outputs.acrName }}
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Log into Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: acr-build-photo-api
        uses: azure/cli@v2
        with:
          azcliversion: 2.67.0
          inlineScript: |
            az acr build \
              --registry ${{ env.ACR_NAME }} \
              -t ${{ env.PHOTO_API_IMAGE }} \
              --build-arg SERVICE_NAME=${{ env.PHOTO_API_NAME }} \
              --build-arg SERVICE_PORT=${{ env.PHOTO_API_PORT }} \
              -f ./Dockerfile .
       
      - run: |
          echo PHOTO_API_IMAGE=${{ env.PHOTO_API_IMAGE }} >> $GITHUB_ENV

  build-resize-api-job:
    runs-on: ubuntu-latest
    needs: deploy-acr-job
    env:
      RESIZE_API_IMAGE: "${{ needs.deploy-acr-job.outputs.acrName }}.azurecr.io/${{ vars.RESIZE_API_NAME }}:${{ vars.VERSION }}"
      ACR_NAME: ${{ needs.deploy-acr-job.outputs.acrName }}
    steps:
      - name: checkout-code
        uses: actions/checkout@main

      - name: log-into-azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: acr-build-resize-api
        id: acr-build-resize-api
        uses: azure/cli@v2
        with:
          azcliversion: 2.67.0
          inlineScript: |
            az acr build \
              --registry ${{ env.ACR_NAME }} \
              -t ${{ env.RESIZE_API_IMAGE }} \
              --build-arg SERVICE_NAME=${{ env.RESIZE_API_NAME }} \
              --build-arg SERVICE_PORT=${{ env.RESIZE_API_PORT }} \
              -f ./Dockerfile .

      - run: |
          echo RESIZE_API_IMAGE=${{ env.RESIZE_API_IMAGE }} >> $GITHUB_ENV

  build-and-deploy-infra-job:
    runs-on: ubuntu-latest
    needs: [deploy-acr-job, build-photo-api-job, build-resize-api-job]
    env:
      ACR_NAME: ${{ needs.deploy-acr-job.outputs.acrName }}
    steps:
    - name: checkout-code
      uses: actions/checkout@main

    - name: log-into-azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: deploy-infra
      uses: azure/arm-deploy@v2
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
        deploymentName: deploy-infra
        resourceGroupName: ${{ env.RG_NAME }}
        template: ./infra/main.bicep
        parameters: "acrName=${{ env.ACR_NAME }} photoApiContainerImage=${{ vars.PHOTO_API_IMAGE }} resizeApiContainerImage=${{ vars.RESIZE_API_IMAGE }}"
        failOnStdErr: true
